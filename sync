#!/usr/bin/env bash

set -eu

package=github.com/KonishchevDmitry/server-metrics
go_cache_args=(-v "$PWD/.cache:/cache" -e GOCACHE=/cache/go -e GOMODCACHE=/cache/mod)
src_dirs="$(realpath --no-symlinks --relative-to "$PWD" $(go list -f '{{.Dir}}' ./...))"

set -x

go get -u -t ./...
go mod tidy
go test ./...

docker run --pull always --rm -v "$PWD:/data" --entrypoint /usr/local/bin/gofmt \
    cytopia/gofmt -s -w $src_dirs

docker run --pull always --rm -v "$PWD:/data" "${go_cache_args[@]}" golang \
    bash -c 'go install -v github.com/daixiang0/gci@latest && cd /data && gci $0 "$@" > /dev/null' \
    write --Section Standard --Section Default --Section "Prefix($package)" $src_dirs

docker run --pull always --rm -t \
    -v "$PWD:/app" -w /app "${go_cache_args[@]}" -e GOLANGCI_LINT_CACHE=/cache/lint \
    golangci/golangci-lint golangci-lint run