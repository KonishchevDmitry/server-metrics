#!/usr/bin/env bash

set -eu

# For some reason builds created by Podman remote are run in /buildah-* cgroup which breaks kernel processes CPU usage
# monitoring, so we override it to /system.slice/buildah-* which is used by non-remote builds.
podman -c server build --cgroup-parent "/system.slice/buildah-$(uuidgen).scope" --pull --tag server-metrics .

ssh -t root@server.lan '
    set -eu

    systemctl restart server-metrics
    sleep 1
    systemctl status server-metrics

    curl -s http://localhost:9101/metrics | sed -r "
        /^#/ d
        s/^(.+) [^ ]+\$/\1/
        /^server_memory_meminfo/!s/^([^{ ]+).*\$/\1/
    " | sort -u > /etc/monitoring/metrics-server.dump

    cd /etc/monitoring && git diff metrics-server.dump >&2
'